DBProxy 位于Application与数据库之间，为应用提供透明的代理服务。
           DBProxy 对外接口采用 mysql protocol，没有定义自己的协议和接口，使得任何mysql的应用都能方便的使用DBProxy。
           DBProxy 没有Build 任何 SQL语句，而是直接接收client的SQL、命令等进行代理转发，DBProxy 采用 SQL、命令等 mysql protocol规范作为统一的接口，完备性得到了保证，能够完成mysql的所有功能操作。如果需要SQL Building或者O-R Mapping，可以在DBProxy上再开发一层 SQL Building/O-R Mapping, 以丰富实际的应用，由于DBProxy没有耦合任何东西，所以这一点能够方便地实现。


### DBProxy主要实现的功能包括：
读写分离
负载均衡
安全认证
失败重连
连接池
表路由功能(2.1.0.0以上版本支持)
表hash功能(2.2.0.0以上版本支持)

1. 读写分离的具体策略如下:
基本原则是读请求发送到从库，写请求发送到主库。
为了避免主从延迟带来的读不到刚刚更新的数据的问题，同一会话中，写请求结束后指定时间内的读请求也发到主库，此时间可配（write_time_interval）。如果此时间内没有新的写请求，则会话回到从库。
事务内的sql不进行读写分离，全部发到主库。
DBProxy会缓存影响会话状态的sql命令，当同一个客户端会话对应的mysql切换时，会在切换后的mysql上回放这些缓存的sql命令，以保证客户端会话的一致性。影响会话状态的sql包括use命令和set命令。

2. 负载均衡
负载均衡的主要作用是使各DB服务器的负载大致相当。
DBProxy可通过各DB的当前连接数，请求时间，重连次数，DB系统状态(status,variables等)，DB机器状态等情况选择当前请求选择的连接

3. 连接池
客户端连接关闭时，DBProxy检查到DB服务器的连接是否可重用，如果不可重用，则断开连接，如果可重用，则并不断开到DB服务器的连接，而是把连接放到连接池，下次客户端再连接DBProxy时，DBProxy从连接池中获取一个连接给客户端使用。如果连接池中没有可用的连接，则建立新连接。
连接池分为两类：读连接池和写连接池，从连接池中获取连接时，根据读写分离的策略确定从哪一类连接池中获取。
某些条件下的连接不可重用，这些条件包括：
 请求处理过程中断开的连接。
 处在事务中未提交且未回滚就断开的连接。
 处在load data过程中的后端连接
 复用次数达到上限的连接。（默认配置为100000，表示重用100000次后会close该连接）
 执行过set变量、prepare、存储过程语句的连接。
 执行过autocommit = 0 的连接 （在最新版本中，版本号>2.1.0.0，set autocommit = 0直接返回OK，因此并为正常开启事务，需要注意！）
连接池中的连接被复用也是有条件的，且不同版本条件不同，具体如下：
2.0.0.0以上版本：db_username相同，client_found_rows选项相同，client_ignore_space选项相同（目前client_found_rows&&client_ignore_space默认相同）。
如果连接池中的连接超过一定时间没有被复用，则释放该连接。此时间可配（server_timeout）

4. 表路由功能(2.1.0.0以上版本支持)
为便于DBA做数据库实例的透明拆分，在2.1.0.0版本中加入表路由功能，该功能允许dbproxy配置表路由规则，根据表名做sql路由，到不同的数据库集群，此过程对业务透明。
此版本使用注意：
增加SQL长度限制，默认为150K，超过则返回sql超长提示
set autocommit = 0 直接返回ok，实际并未开启事务，事务请使用 begin commit||rollback
如已经使用分片功能，show tables等一系列无tablename的SQL，可能会返回预期之外的值

5. 表hash功能(2.2.0.0以上版本支持)
有的时候，业务方需要做表hash，以达到支持更大数据量和提供性能，因此在2.2.0.0以上版本加入表hash功能，对于业务方来说，物理表可能是hash成100张，但是在使用的时候，只需要写逻辑表名，拼接表名由dbproxy完成，该功能使用sql hint方式来完成，在使用该功能之前，业务方和DBA需要沟通约定：
散表规则，目前只支持直接取模的方式
散表份数，如散成100张表，表A对应表A_0 - 表A_99
sqlhint的使用方式见《特殊功能简介》
