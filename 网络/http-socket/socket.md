### IO-NIO-IO多路复用-AIO
- IO是面向流的、阻塞的； 
  NIO 则是面向块的、非阻塞的。
  
- NIO介绍
    1. NIO是面向缓冲区的。数据读取到一个它稍后处理的缓冲区，需要时可在缓冲区中前后移动，更灵活性。
    2. 如果没有数据可用时，就什么都不会获取(返回-1)，而不是保持线程阻塞。可以做到用一个线程来处理多个IO操作的。
    3. 在NIO中，你可以操作通道和缓冲，数据总是从通道被读取到缓冲中或者从缓冲写入到通道中。
    4. 默认创建的socket都是阻塞的，非阻塞IO要求socket被设置为NONBLOCK
  - nio缺点
     1. 如果有多个io，需要一个一个检测，每次检测调用read都会发生上下文切换（read是系统调用，每调用一次就得在用户态和核心态切换一次）
     2. 第一次读取不到时，不知道应该等待多久再尝试读取一次

- IO多路复用
- 多路复用定义：一个线程监听多个端口or文件描述符，减轻cpu线程切换压力
1. 机制：程序注册一组socket文件描述符给操作系统，表示“我要监视这些fd是否有IO事件发生，有了就告诉程序处理”。
2. 和NIO是要配合一起使用才有实际意义：NIO多路复用
3. 有select、poll、epoll三种方式。
4. IO多路复用使用了reactor设计模式(更优雅地实现异步编程的方式)；
   4.1 单线程模式；(单线程会有handler阻塞时无法处理其他请求)
   4.2 多线程模式；(handler操作都是由一个特定的NIO线程池负责)
   4.3 主从模式；(acceptor使用了线程池来处理大量的客户端请求)
 
### IO 多路复用模型：  select， poll， epoll
- 多路复用本质上是同步I/O， 因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的，
   多路复用指用一个线程实现多个io读写； 
   异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间

- select本质上是通过设置或者检查存放fd标志位的数据结构来进行下一步处理, 
     select只有一个函数，调用select时，需要将监听句柄和最大等待时间作为参数传递进去，select会发生阻塞，
     直到一个事件发生了，或者等到最大1秒钟(tv定义了这个时间长度）就返回。
 - 缺点：
   1. 单个进程可监视的fd数量被限制，即能监听端口的大小有限。
        一般来说这个数目和系统内存关系很大，具体数目可以cat /proc/sys/fs/file-max察看。32位机默认是1024个。64位机默认是2048.
   2. 对socket进行扫描时是线性扫描，即采用轮询的方法，效率较低：
   3. 需要维护一个用来存放大量fd的数据结构，这样会使得用户空间和内核空间在传递该结构时复制开销大
   4. select是无状态的，内核不会保存注册的fd的状态；每次调用select，都需要把fd集合从用户态拷贝到内核态，复制开销大

- poll
    - poll的实现和select相同点：
        - 它将用户传入的数组拷贝到内核空间，然后查询每个fd对应的设备状态，如果设备就绪则在设备等待队列中加入一项并继续遍历，如果遍历完所有fd后没有发现就绪设备，则挂起当前进程，直到设备就绪或者主动超时，被唤醒后它又要再次遍历fd
        - poll和select同样存在一个缺点: 包含大量文件描述符的数组被整体复制于用户态和内核的地址空间之间，而不论这些文件描述符是否就绪，它的开销随着文件描述符数量的增加而线性增大。
    - poll和select的不同：
        - 描述fd集合的方式不同，poll使用pollfd结构而不是select的fd_set结构
        - poll没有最大文件描述符数量的限制, 原因是它是基于链表来存储。但是同样有一个缺点：
          - 大量的fd的数组被整体复制于用户态和内核地址空间之间，而不管这样的复制是不是有意义。                   
          - poll还有一个特点是“水平触发”，如果报告了fd后，没有被处理，那么下次poll时会再次报告该fd。

- epoll
    - 有两种模式， LT(水平触发，fd事件如果没被处理，则下次epoll继续报告该fd)，ET(高速模式，fd的事件只会上报一次)
    - epoll的优点：
      1、没有最大并发连接的限制，能打开的FD的上限远大于1024（1G的内存上能监听约10万个端口）；
      2、效率提升，不是轮询的方式，基于回调函数注册方式,只有活跃可用的FD才会调用callback函数；即Epoll最大的优点就在于它只管你“活跃”的连接，而跟连接总数无关，
      3、内存拷贝，利用mmap()文件映射内存加速与内核空间的消息传递；即epoll使用mmap减少复制开销。
     
 
 
 